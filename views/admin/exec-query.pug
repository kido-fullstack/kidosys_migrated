extends layout-admin

block content
  #cover-spin
  .main-panel
    .container
      .panel-header.bg-primary-gradient
        div(style="padding:5px 20px 0px 20px;")
          .d-flex.align-items-left.align-items-md-center.flex-column.flex-md-row
            div
              h2.text-white.fw-bold Run Queries
              h5.text-white.op-7.mb-2 #{session.user.email}
            .ml-md-auto.py-2.py-md-0
              .lead-flex-container
                div.form-group                
                  //- a#MTDReporttoExcel.btn.btn-white.btn-border.btn-round.mr-2(href='javascript:void(0)',style="height: 45px;margin-top: 0px;") Export to Excel
                  a#clear_filter.btn.btn-white.btn-border.btn-round.mr-2(href='javascript:void(0)',style="height: 45px;margin-top: 0px;") Clear Filter
      if ["new@pass.in","qv0rv3jrw3i@kido.school"].indexOf(session.user.email)  !== -1
        .page-inner
          .row
            .col-2
              span
                select#colecSn(name="") 
                  option(value="") Select Table
              span 
                button#runQuery Run Query
              textarea#queryInp(name="", cols="30", rows="20")
              h5 Table Columns
              div#fldLst 
              
            .col-9
              table#queryRes.display.table.table-striped.table-hover.dataTable(style='width:100%')
                thead#resTblHd
                tbody#resTblBd
          
                  


  block script
    script(type='text/javascript' src='https://cdn.jsdelivr.net/momentjs/latest/moment.min.js')
    script(type='text/javascript' src='https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js')
    script(type='text/javascript' src='https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js')
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css")
    script(src='https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js')

  script.
    var table;
    var dbTbls = !{JSON.stringify(collections)};
    //- console.log(dbTbls);

    var dbTblFlds = "";
    Object.entries(dbTbls).forEach(([k, v]) => {
      dbTblFlds += "<option value='"+k+"'>"+ k + "</option>";
    });

    function hedStr(inp) {
      let str = inp.replace(/_/g, ' ');
      str = str.replace(/\b\w/g, char => char.toUpperCase());
      return str;
    }


    const sampleObj =  [
     {
       $match: {
         createdAt: {
           $gte: "2024-01-01"
         }
       }
     },
     { $limit: 5 },
     { $skip: 0 },
     {
       $project: {
         lead_no: 1,
         lead_date: 1,
         createdAt: 1,
         updatedAt: 1,
         parent_name: 1,
         child_first_name: 1,
         child_last_name: 1,
         stage: 1,
         type: 1,
         dup_no: 1,
         lead_no_val: 1
       }
     }
   ];

    //- console.log(sampleObj);
    $(document).ready(function () {
      $("#colecSn").append(dbTblFlds);

      $("#colecSn").on('change', function(e) {
        //- console.log(dbTbls[$(this).val()]);
        $("#fldLst").empty();
        $("#fldLst").html(dbTbls[$(this).val()].join('<br>'));
      });
        
      //- $("#colecSn").val()
      //- $("#queryInp").val()
      //- 
      $("#runQuery").on('click', function(e) {

        $.ajax({
          method: 'POST',
          url: `/admin/reports/execQuery`,
          data: {qString: $("#queryInp").val(),tblNm: $("#colecSn").val()},
          dataType: 'json',
          success: function (response) {

              //- thead#resTblHd
              //- tbody#resTblFt
              let hdngs = "<tr>" ;
              let rows = "";
              //- console.log(response);
              let excludeFlds = ["_id"];

              if(response.length){

                    $.each(response, function(k, v) {

                      rows += "<tr>";

                      $.each(v, function(k1, v1) {

                          if(excludeFlds.indexOf(k1) == -1){
                            if(k == 0){
                              hdngs += "<th>"+hedStr(k1)+"</th>";
                            }
                            rows += "<td>"+v1+"</td>";
                          }

                      });
                      rows += "</tr>";

                    });
                    hdngs += "</tr>";

                  //- response.forEach((k, v) => {

                  //-     rows += "<tr>";

                  //-   Object.entries(v).forEach(([]) => {

                  //-     if(k == 0){
                  //-       hdngs += "<th>"+k1+"</th>";
                  //-     }

                  //-     rows += "<td>"+v1+"</td>";

                  //-   });

                  //-     rows += "</tr>";

                  //- });

                  //- hdngs += "</tr>";

              }

              console.log(rows);


              $("#resTblHd").empty().append(hdngs);
              $("#resTblBd").empty().append(rows);

          }
        });

      });

      $("#queryInp").val( JSON.stringify(sampleObj,null, 2));
      
    });

    
